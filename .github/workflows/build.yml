name: BuildGalileo
on:
  push:
    branches: [ main ]
    paths-ignore:
      - conda/**
      - docker/**
      - docs/**
      - examples/**
      - testdata/**
  pull_request:
    branches: [ main ]
    paths-ignore:
      - conda/**
      - docker/**
      - docs/**
      - examples/**
      - testdata/**
  workflow_dispatch:

jobs:
  build_and_test:
    name: build and test Galileo in docker container
    runs-on: ubuntu-latest
    container: jdgalileo/galileo:devel-cpu
    steps:
      - name: check out code
        uses: actions/checkout@v2
        with:
          ref: main
          submodules: true
      - name: build
        run: |
          # source ./build.sh
          export PATH=/opt/python/cp38-cp38/bin:/usr/lib/jvm/java/bin:/usr/local/zookeeper/bin:/opt/hadoop/bin:$PATH
          export LD_LIBRARY_PATH=/lib64:/usr/local/lib:/usr/local/lib64:/usr/lib/jvm/java/jre/lib/amd64/server:/opt/hadoop/lib/native:$LD_LIBRARY_PATH
          echo $LIBRARY_PATH
          ld --verbose
          export LIBRARY_PATH=/lib64:/usr/local/lib:/usr/local/lib64:/usr/lib/jvm/java/jre/lib/amd64/server:/opt/hadoop/lib/native
          echo $LIBRARY_PATH
          ld --verbose
          # python3 setup.py build
          # python3 setup.py install
          # python3 -c "import galileo; import galileo.tf"
      - name: test
        run: bash ./galileo/tests/run_tests.sh
